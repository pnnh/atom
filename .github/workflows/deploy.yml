name: Build and Deploy to GitHub Packages

on:
  push:
    branches: [main]  # Trigger on push to main; adjust as needed

permissions:
  contents: write   # Required for tagging and releasing
  packages: write  # Required for pushing to GHCR
  pull-requests: read  # Required for label-based overrides

jobs:
  test:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            submodules: recursive  # This enables recursive submodule checkout
            fetch-depth: 0  # Fetch all history for accurate versioning

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '22'
            cache: 'npm' # 开启 npm 缓存

        - name: Install dependencies
          run: npm ci --legacy-peer-deps

        - name: Run tests
          run: npm run test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # This enables recursive submodule checkout
          fetch-depth: 0  # Fetch all history for accurate versioning

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm' # 开启 npm 缓存
          registry-url: 'https://npm.pkg.github.com'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run build
        run: npm run build

      - name: Create Tag and Release
        id: release
        uses: rymndhng/release-on-push-action@v0.28.0  # Pin to a version for stability
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          bump_version_scheme: minor  # Default: minor; options: major, patch, norelease
          tag_prefix: v  # Prefix for tags, e.g., v1.2.3
          release_name: Release 
          use_github_release_notes: true  # Use GitHub's auto-generated notes
          max_commits: 50  # Limit notes to recent commits

      - name: Log Release Info
        run: |
          echo "Created tag: ${{ steps.release.outputs.tag_name }}"
          echo "Release URL: ${{ steps.release.outputs.html_url }}"
          echo "Version: ${{ steps.release.outputs.version }}"
      
      - name: Update package.json version
        if: steps.release.outputs.tag_name != ''
        run: |
          npm version ${{ steps.release.outputs.version }} --no-git-tag-version --allow-same-version=false

      - name: Publish to GitHub Packages
        if: steps.release.outputs.tag_name != '' # Only publish if a new tag was created
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub 令牌认证

